<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>X URL Generator App</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen;
    background-color: #000;
    color: #e7e9ea;
    padding: 20px;
  }
  input {
    display: block;
    margin-bottom: 12px;
    padding: 10px;
    background: #16181c;
    border: 1px solid #2f3336;
    color: #e7e9ea;
    width: 100%;
    max-width: 400px;
    border-radius: 9999px;
  }
  button {
    background: #1d9bf0;
    color: white;
    border: none;
    padding: 10px 20px;
    margin-bottom: 12px;
    border-radius: 9999px;
    cursor: pointer;
    font-weight: bold;
    margin-right: 8px;
  }
  button:hover {
    background: #1483cc;
  }
  .x-tab {
    margin: 8px 0;
    padding: 12px;
    border-radius: 9999px;
    background: #16181c;
    display: inline-block;
  }
  .x-tab a {
    text-decoration: none;
    color: #1d9bf0;
    font-weight: 600;
  }
  .x-tab a:hover {
    text-decoration: underline;
  }

  /* Auth status */
  #authStatus {
    display: flex;
    align-items: center;
    font-weight: bold;
    margin-bottom: 12px;
    font-size: 1.1em;
    gap: 8px;
    user-select: none;
  }
  #authStatus .icon {
    display: inline-block;
    width: 20px;
    height: 20px;
    animation-duration: 1.5s;
    animation-iteration-count: infinite;
    animation-timing-function: ease-in-out;
  }
  #authStatus.valid {
    color: #2ecc71;
  }
  #authStatus.valid .icon {
    animation-name: pulse-green;
  }
  #authStatus.invalid {
    color: #e74c3c;
  }
  #authStatus.invalid .icon {
    animation-name: shake-red;
  }
  @keyframes pulse-green {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
  }
  @keyframes shake-red {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-3px); }
    50% { transform: translateX(3px); }
    75% { transform: translateX(-3px); }
  }
</style>
</head>
<body>

<div id="authStatus">Loading...</div>

<input id="clientID" placeholder="Client ID" />
<button id="oauthBtn">Login with X</button>
<button id="logoutBtn">Logout</button>
<input id="apiToken" placeholder="Bearer Token" />
<input id="communityID" placeholder="Community ID" />
<input id="listID" placeholder="List ID" />
<input id="userID" placeholder="User ID" />

<div id="tabs"></div>

<script>
  class XURLGenerator {
    constructor() {
      this.communityID = null;
      this.listID = null;
      this.userID = null;
      this.apiToken = null;
    }
    setCommunityID(id) { this.communityID = id; }
    setListID(id) { this.listID = id; }
    setUserID(id) { this.userID = id; }
    setApiToken(token) { this.apiToken = token; }
    generateCommunityURLs() {
      if (!this.communityID) return [];
      return [
        { label: "Members", url: `https://x.com/i/communities/${this.communityID}/members` },
        { label: "Moderators", url: `https://x.com/i/communities/${this.communityID}/moderators` }
      ];
    }
    generateListURLs() {
      if (!this.listID) return [];
      return [
        { label: "Followers", url: `https://x.com/i/lists/${this.listID}/followers` },
        { label: "Members", url: `https://x.com/i/lists/${this.listID}/members` }
      ];
    }
    generateUserURLs() {
      if (!this.userID) return [];
      return [
        { label: "Followers", url: `https://x.com/${this.userID}/followers` },
        { label: "Following", url: `https://x.com/${this.userID}/following` },
        { label: "Verified Followers", url: `https://x.com/${this.userID}/verified_followers` }
      ];
    }
    generateAllURLs() {
      return [
        ...this.generateCommunityURLs(),
        ...this.generateListURLs(),
        ...this.generateUserURLs()
      ];
    }
    async fetchBlockedUserIds() {
      if (!this.apiToken || !this.userID) return [];
      const endpoint = `https://api.twitter.com/2/users/${this.userID}/blocking`;
      try {
        const response = await fetch(endpoint, {
          headers: { Authorization: `Bearer ${this.apiToken}` }
        });
        if (!response.ok) return [];
        const data = await response.json();
        return data.data ? data.data.map(user => user.id) : [];
      } catch {
        return [];
      }
    }
  }

  let oauthData = {
    clientId: '',
    accessToken: '',
    refreshToken: '',
    expiresAt: 0
  };

  async function initiateOAuthFlow() {
    const clientId = document.getElementById("clientID").value;
    if(!clientId) {
      alert("Inserisci il Client ID prima di procedere al login");
      return;
    }
    const redirectUri = window.location.origin;
    const state = crypto.randomUUID();
    const codeVerifier = generateCodeVerifier();
    const codeChallenge = await generateCodeChallenge(codeVerifier);

    sessionStorage.setItem('code_verifier', codeVerifier);
    sessionStorage.setItem('client_id', clientId);

    const params = new URLSearchParams({
      response_type: 'code',
      client_id: clientId,
      redirect_uri: redirectUri,
      scope: 'tweet.read users.read block.read offline.access',
      state: state,
      code_challenge: codeChallenge,
      code_challenge_method: 'S256'
    });

    window.location.href = `https://twitter.com/i/oauth2/authorize?${params.toString()}`;
  }

  async function handleOAuthCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const codeVerifier = sessionStorage.getItem('code_verifier');
    const clientId = sessionStorage.getItem('client_id');
    if (!code || !codeVerifier || !clientId) return null;

    const response = await fetch('https://api.twitter.com/2/oauth2/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: clientId,
        redirect_uri: window.location.origin,
        code: code,
        code_verifier: codeVerifier
      })
    });

    if (!response.ok) return null;
    const data = await response.json();
    oauthData = {
      clientId,
      accessToken: data.access_token,
      refreshToken: data.refresh_token,
      expiresAt: Date.now() + data.expires_in * 1000
    };
    localStorage.setItem('oauthData', JSON.stringify(oauthData));
    return oauthData.accessToken;
  }

  async function refreshAccessToken() {
    const stored = localStorage.getItem('oauthData');
    if (stored) {
      oauthData = JSON.parse(stored);
    }
    if (Date.now() < oauthData.expiresAt - 60000) return oauthData.accessToken;
    if (!oauthData.refreshToken) return null;

    const response = await fetch('https://api.twitter.com/2/oauth2/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        grant_type: 'refresh_token',
        refresh_token: oauthData.refreshToken,
        client_id: oauthData.clientId
      })
    });

    if (!response.ok) return null;
    const data = await response.json();
    oauthData.accessToken = data.access_token;
    oauthData.expiresAt = Date.now() + data.expires_in * 1000;
    localStorage.setItem('oauthData', JSON.stringify(oauthData));
    return oauthData.accessToken;
  }

  function logout() {
    localStorage.removeItem('oauthData');
    sessionStorage.clear();
    location.reload();
  }

  function generateCodeVerifier() {
    const array = new Uint8Array(32);
    crypto.getRandomValues(array);
    return btoa(String.fromCharCode(...array)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  async function generateCodeChallenge(verifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(verifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  // Icon SVG inline
  const validIcon = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>`;
  const invalidIcon = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;

  function updateAuthStatus(isValid) {
    const statusIndicator = document.getElementById('authStatus');
    if (isValid) {
      statusIndicator.className = 'valid';
      statusIndicator.innerHTML = `${validIcon} Access Token valido`;
    } else {
      statusIndicator.className = 'invalid';
      statusIndicator.innerHTML = `${invalidIcon} Non autenticato`;
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const generator = new XURLGenerator();

    const inputs = {
      client: document.getElementById("clientID"),
      token: document.getElementById("apiToken"),
      community: document.getElementById("communityID"),
      list: document.getElementById("listID"),
      user: document.getElementById("userID")
    };

    const tabsContainer = document.getElementById("tabs");
    const oauthBtn = document.getElementById("oauthBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    oauthBtn.addEventListener('click', initiateOAuthFlow);
    logoutBtn.addEventListener('click', logout);

    const accessToken = await handleOAuthCallback();
    if (accessToken) {
      inputs.token.value = accessToken;
    } else {
      // try load saved token
      const saved = localStorage.getItem('oauthData');
      if (saved) {
        const parsed = JSON.parse(saved);
        if(parsed.accessToken) inputs.token.value = parsed.accessToken;
      }
    }

    const updateTabs = async () =>
